name: ğŸš€ ECR ë°°í¬

on:
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2

jobs:
  build-and-push:
    name: ğŸ³ ${{ matrix.service }} ë¹Œë“œ & í‘¸ì‹œ
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read
    
    strategy:
      matrix:
        include:
          - service: llm-server
            directory: LLM_server
            dockerfile: dockerfile
            description: "ëŒ€í™”í˜• AI ëª¨ë¸ ì„œë²„"
         
          - service: tts-server
            directory: TTS_server
            dockerfile: dockerfile
            description: "í…ìŠ¤íŠ¸ë¥¼ ìŒì„±ìœ¼ë¡œ ë³€í™˜"
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref_name }}
        
      - name: ğŸ“‹ ì„œë¹„ìŠ¤ ì •ë³´ ì¶œë ¥
        run: |
          echo "ğŸ¯ ë°°í¬ ëŒ€ìƒ: ${{ matrix.service }}"
          echo "ğŸ“ ì„¤ëª…: ${{ matrix.description }}"
          echo "ğŸ“ ë””ë ‰í† ë¦¬: ${{ matrix.directory }}"
          echo "ğŸ³ Dockerfile: ${{ matrix.dockerfile }}"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "ğŸ“ ì»¤ë°‹: ${{ github.sha }}"
          echo "ğŸ‘¤ ì‘ì„±ì: ${{ github.actor }}"

      - name: ğŸ” AWS ì„¤ì • í™•ì¸
        run: |
          echo "ğŸ” AWS ê³„ì • ID: ${{ secrets.AWS_ACCOUNT_ID }}"
          echo "ğŸŒ AWS ë¦¬ì „: ${{ secrets.AWS_REGION }}"
          echo "ğŸ¯ ì—­í•  ARN: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/ora-ecr-oicdrole"
          echo "ğŸ“‚ GitHub ë¦¬í¬ì§€í† ë¦¬: ${{ github.repository }}"
          echo "ğŸ”— GitHub Actor: ${{ github.actor }}"
          echo "ğŸŒ¿ GitHub Ref: ${{ github.ref }}"

      - name: ğŸ” AWS ì¸ì¦ ì„¤ì • (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::319641749746:role/ai-server-backup
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-${{ matrix.service }}-${{ github.run_id }}

      - name: âœ… AWS ì¸ì¦ í™•ì¸
        run: |
          echo "ğŸ” AWS ì¸ì¦ ìƒíƒœ í™•ì¸..."
          aws sts get-caller-identity
          echo "âœ… AWS ì¸ì¦ ì„±ê³µ!"

      - name: ğŸª Amazon ECR ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ğŸ” ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„¸ í™•ì¸
        run: |
          echo "ğŸ“ í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬:"
          pwd
          echo "ğŸŒ¿ í˜„ì¬ ë¸Œëœì¹˜:"
          git branch
          echo "ğŸ“‚ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la
          echo "ğŸ“‚ ëª¨ë“  í•˜ìœ„ ë””ë ‰í† ë¦¬ í™•ì¸ (ê¹Šì´ 3):"
          find . -maxdepth 3 -type d | sort
          echo "ğŸ“‚ Server ê´€ë ¨ ë””ë ‰í† ë¦¬ë§Œ ê²€ìƒ‰:"
          find . -maxdepth 2 -type d -iname "*server*" | sort
          echo "ğŸ“‚ ëª¨ë“  dockerfile ê²€ìƒ‰:"
          find . -name "dockerfile" -o -name "Dockerfile" -o -name "*.dockerfile" | sort
          echo "ğŸ“‚ Python ê´€ë ¨ íŒŒì¼ ê²€ìƒ‰:"
          find . -name "*.py" -o -name "requirements.txt" -o -name "manage.py" | head -10
          echo "ğŸ“‚ ëŒ€ìƒ ë””ë ‰í† ë¦¬ í™•ì¸ (${{ matrix.directory }}):"
          if [ -d "${{ matrix.directory }}" ]; then
            echo "âœ… ${{ matrix.directory }} ë””ë ‰í† ë¦¬ ì¡´ì¬"
            ls -la "${{ matrix.directory }}"
            echo "ğŸ“‚ ${{ matrix.directory }} ë‚´ë¶€ íŒŒì¼ë“¤:"
            find "${{ matrix.directory }}" -type f -name "*dockerfile*" -o -name "*.py" -o -name "requirements.txt" | head -5
          else
            echo "âŒ ${{ matrix.directory }} ë””ë ‰í† ë¦¬ ì—†ìŒ"
            echo "ğŸ” ë¹„ìŠ·í•œ ì„œë²„ ë””ë ‰í† ë¦¬ ê²€ìƒ‰:"
            ls -la | grep -i server || echo "server ê´€ë ¨ ë””ë ‰í† ë¦¬ ì—†ìŒ"
            echo "ğŸ” ëŒ€ì•ˆ ë””ë ‰í† ë¦¬ ê²€ìƒ‰:"
            find . -maxdepth 2 -type d -name "*$(echo ${{ matrix.service }} | sed 's/-/_/g')*" -o -name "*$(echo ${{ matrix.service }} | sed 's/_/-/g')*" | head -5
          fi

      - name: ğŸ—ï¸ ECR ë¦¬í¬ì§€í† ë¦¬ í™•ì¸ (ai-server-backup ì‚¬ìš©)
        run: |
          echo "ğŸ” ECR ë¦¬í¬ì§€í† ë¦¬ í™•ì¸: ai-server-backup"
          
          if aws ecr describe-repositories --repository-names ai-server-backup --region ${{ secrets.AWS_REGION }} 2>/dev/null; then
            echo "âœ… ECR ë¦¬í¬ì§€í† ë¦¬ 'ai-server-backup' ì´ë¯¸ ì¡´ì¬"
          else
            echo "ğŸ—ï¸ ECR ë¦¬í¬ì§€í† ë¦¬ 'ai-server-backup' ìƒì„± ì¤‘..."
            aws ecr create-repository \
              --repository-name ai-server-backup \
              --region ${{ secrets.AWS_REGION }} \
              --image-scanning-configuration scanOnPush=true
            echo "âœ… ECR ë¦¬í¬ì§€í† ë¦¬ 'ai-server-backup' ìƒì„± ì™„ë£Œ"
          fi

      - name: ğŸ³ ${{ matrix.service }} ì´ë¯¸ì§€ ë¹Œë“œ & ECR í‘¸ì‹œ
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
          SHORT_SHA: ${{ github.sha }}
        run: |
          echo "ğŸš€ === ${{ matrix.service }} ECR ë°°í¬ ì‹œì‘ ==="
          echo "ğŸ“‹ ì„œë¹„ìŠ¤: ${{ matrix.service }}"
          echo "ğŸ“ ì„¤ëª…: ${{ matrix.description }}"
          echo "ğŸŒ ë¦¬ì „: ${{ secrets.AWS_REGION }}"
          
          # ECR ì´ë¯¸ì§€ URI ìƒì„± (ai-server-backup ë¦¬í¬ì§€í† ë¦¬ ì‚¬ìš©)
          ECR_IMAGE_URI=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/ai-server-backup
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          
          echo "ğŸ”— ECR URI: $ECR_IMAGE_URI"
          echo "ğŸ·ï¸  íƒœê·¸: latest, $SHORT_SHA, ${{ github.sha }}"
          
          # Dockerfile ê²½ë¡œ í™•ì¸ (í˜„ì¬ ë¸Œëœì¹˜ êµ¬ì¡° ì ì‘í˜•)
          echo "ğŸ” ${{ matrix.service }} Dockerfile ê²€ìƒ‰ ì‹œì‘..."
          
          DOCKERFILE_PATH=""
          BUILD_CONTEXT=""
          
          # 1ë‹¨ê³„: ì •í™•í•œ ê²½ë¡œ í™•ì¸
          if [ -d "${{ matrix.directory }}" ] && [ -f "${{ matrix.directory }}/${{ matrix.dockerfile }}" ]; then
            DOCKERFILE_PATH="${{ matrix.directory }}/${{ matrix.dockerfile }}"
            BUILD_CONTEXT="${{ matrix.directory }}"
            echo "âœ… ì •í™•í•œ ê²½ë¡œì—ì„œ ë°œê²¬: $DOCKERFILE_PATH"
          else
            echo "âš ï¸ ì •í™•í•œ ê²½ë¡œì—ì„œ ì°¾ì§€ ëª»í•¨: ${{ matrix.directory }}/${{ matrix.dockerfile }}"
            
            # 2ë‹¨ê³„: ì„œë¹„ìŠ¤ëª… ê¸°ë°˜ ë””ë ‰í† ë¦¬ ê²€ìƒ‰
            SERVICE_PATTERNS=(
              "${{ matrix.service }}"
              "$(echo ${{ matrix.service }} | sed 's/-/_/g')"
              "$(echo ${{ matrix.service }} | sed 's/_/-/g')"
              "$(echo ${{ matrix.service }} | tr '[:lower:]' '[:upper:]')"
              "$(echo ${{ matrix.service }} | tr '[:upper:]' '[:lower:]')"
            )
            
            for pattern in "${SERVICE_PATTERNS[@]}"; do
              echo "ğŸ” íŒ¨í„´ ê²€ìƒ‰: $pattern"
              # ëŒ€ì†Œë¬¸ì ë¬´ì‹œí•˜ê³  ë””ë ‰í† ë¦¬ ê²€ìƒ‰
              FOUND_DIR=$(find . -maxdepth 2 -type d -iname "*${pattern}*" | head -1)
              if [ -n "$FOUND_DIR" ]; then
                # í•´ë‹¹ ë””ë ‰í† ë¦¬ì—ì„œ dockerfile ê²€ìƒ‰
                FOUND_DOCKERFILE=$(find "$FOUND_DIR" -iname "*dockerfile*" -type f | head -1)
                if [ -n "$FOUND_DOCKERFILE" ]; then
                  DOCKERFILE_PATH="$FOUND_DOCKERFILE"
                  BUILD_CONTEXT="$FOUND_DIR"
                  echo "âœ… íŒ¨í„´ ë§¤ì¹­ìœ¼ë¡œ ë°œê²¬: $DOCKERFILE_PATH (ë””ë ‰í† ë¦¬: $FOUND_DIR)"
                  break
                fi
              fi
            done
            
            # 3ë‹¨ê³„: ì „ì²´ í”„ë¡œì íŠ¸ì—ì„œ ì„œë¹„ìŠ¤ëª… í¬í•¨ dockerfile ê²€ìƒ‰
            if [ -z "$DOCKERFILE_PATH" ]; then
              echo "ğŸ” ì „ì²´ í”„ë¡œì íŠ¸ì—ì„œ ì„œë¹„ìŠ¤ ê´€ë ¨ dockerfile ê²€ìƒ‰ ì¤‘..."
              for pattern in "${SERVICE_PATTERNS[@]}"; do
                FOUND_DOCKERFILE=$(find . -path "*${pattern}*" -iname "*dockerfile*" -type f | head -1)
                if [ -n "$FOUND_DOCKERFILE" ]; then
                  DOCKERFILE_PATH="$FOUND_DOCKERFILE"
                  BUILD_CONTEXT=$(dirname "$FOUND_DOCKERFILE")
                  echo "âœ… ì „ì²´ ê²€ìƒ‰ìœ¼ë¡œ ë°œê²¬: $DOCKERFILE_PATH"
                  break
                fi
              done
            fi
          fi
          
          # ìµœì¢… ê²€ì¦
          if [ -z "$DOCKERFILE_PATH" ] || [ ! -f "$DOCKERFILE_PATH" ]; then
            echo "âŒ ${{ matrix.service }} ë¹Œë“œ ì‹¤íŒ¨: Dockerfileì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            echo "ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  dockerfile:"
            find . -iname "*dockerfile*" -type f
            echo "ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  ë””ë ‰í† ë¦¬:"
            find . -maxdepth 2 -type d | grep -E "(server|Server|SERVER)" || echo "server ê´€ë ¨ ë””ë ‰í† ë¦¬ ì—†ìŒ"
            exit 1
          fi
          
          echo "ğŸ¯ ìµœì¢… ì„ íƒëœ Dockerfile: $DOCKERFILE_PATH"
          echo "ğŸ“ ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸: $BUILD_CONTEXT"
          
          # ë¹Œë“œ ì‹œì‘
          echo "ğŸ”¨ ${{ matrix.service }} ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
          BUILD_START=$(date +%s)
          
          # Docker ë¹Œë“œ (ì„œë¹„ìŠ¤ë³„ íƒœê·¸)
          docker build \
            -t $ECR_IMAGE_URI:${{ matrix.service }}-latest \
            -t $ECR_IMAGE_URI:${{ matrix.service }}-$SHORT_SHA \
            -t $ECR_IMAGE_URI:${{ matrix.service }}-${{ github.sha }} \
            -f "$DOCKERFILE_PATH" \
            "$BUILD_CONTEXT"
          
          if [ $? -eq 0 ]; then
            BUILD_END=$(date +%s)
            BUILD_DURATION=$((BUILD_END - BUILD_START))
            echo "âœ… ${{ matrix.service }} ë¹Œë“œ ì™„ë£Œ! (ì†Œìš”ì‹œê°„: ${BUILD_DURATION}ì´ˆ)"
          else
            echo "âŒ ${{ matrix.service }} ë¹Œë“œ ì‹¤íŒ¨!"
            exit 1
          fi
          
          # ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ
          echo "â¬†ï¸ ${{ matrix.service }} ECR í‘¸ì‹œ ì‹œì‘..."
          PUSH_START=$(date +%s)
          
          # ì—¬ëŸ¬ íƒœê·¸ë¡œ í‘¸ì‹œ (ì„œë¹„ìŠ¤ë³„ íƒœê·¸)
          docker push $ECR_IMAGE_URI:${{ matrix.service }}-latest
          docker push $ECR_IMAGE_URI:${{ matrix.service }}-$SHORT_SHA
          docker push $ECR_IMAGE_URI:${{ matrix.service }}-${{ github.sha }}
          
          if [ $? -eq 0 ]; then
            PUSH_END=$(date +%s)
            PUSH_DURATION=$((PUSH_END - PUSH_START))
            echo "âœ… ${{ matrix.service }} ECR í‘¸ì‹œ ì™„ë£Œ! (ì†Œìš”ì‹œê°„: ${PUSH_DURATION}ì´ˆ)"
          else
            echo "âŒ ${{ matrix.service }} ECR í‘¸ì‹œ ì‹¤íŒ¨!"
            exit 1
          fi
          
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          echo "ECR_IMAGE_URI_${{ matrix.service }}=$ECR_IMAGE_URI:${{ matrix.service }}-${{ github.sha }}" >> $GITHUB_ENV
          echo "ğŸ‰ ${{ matrix.service }} ì´ë¯¸ì§€ê°€ ai-server-backup ë¦¬í¬ì§€í† ë¦¬ì— ë°°í¬ ì™„ë£Œ!"

      - name: ğŸ“‹ ${{ matrix.service }} ë°°í¬ ê²°ê³¼ ìš”ì•½
        run: |
          echo "ğŸ¯ === ${{ matrix.service }} ë°°í¬ ì™„ë£Œ ìš”ì•½ ==="
          echo "ğŸ“¦ ì„œë¹„ìŠ¤: ${{ matrix.service }}"
          echo "ğŸ“ ì„¤ëª…: ${{ matrix.description }}"
          echo "ğŸ·ï¸  ì´ë¯¸ì§€ íƒœê·¸: ${{ matrix.service }}-latest, ${{ matrix.service }}-$(echo ${{ github.sha }} | cut -c1-7), ${{ matrix.service }}-${{ github.sha }}"
          echo "ğŸ“ ECR ë¦¬í¬ì§€í† ë¦¬: ai-server-backup"
          echo "ğŸ”— ECR URI: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/ai-server-backup"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "ğŸ“ ì»¤ë°‹: ${{ github.sha }}"
          echo "ğŸ‘¤ ì‘ì„±ì: ${{ github.actor }}"
          echo "ğŸ“ ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸: ${{ matrix.directory }}"
          echo "ğŸ³ Dockerfile: ${{ matrix.dockerfile }}"
          echo "â° ì™„ë£Œ ì‹œê°„: $(date)"
          echo "âœ… ${{ matrix.service }} ì´ë¯¸ì§€ê°€ ai-server-backup ECR ë¦¬í¬ì§€í† ë¦¬ì— ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "=========================================="
          
  # ëª¨ë“  ì„œë¹„ìŠ¤ ë°°í¬ ì™„ë£Œ í›„ ìš”ì•½
  deploy-summary:
    name: ğŸ“Š ì „ì²´ ë°°í¬ ì™„ë£Œ ìš”ì•½
    runs-on: ubuntu-latest
    needs: build-and-push
    if: always()
    steps:
      - name: ğŸ“‹ ì „ì²´ ë°°í¬ ê²°ê³¼ ìš”ì•½
        run: |
          echo "ğŸ¯ === ì „ì²´ ECR ë°°í¬ ì™„ë£Œ ìš”ì•½ ==="
          echo "ğŸ“¦ ë°°í¬ëœ ì„œë¹„ìŠ¤: llm-server, tts-server"
          echo "ğŸŒ AWS ë¦¬ì „: ap-northeast-2"
          echo "ğŸ“ ECR ë¦¬í¬ì§€í† ë¦¬: ai-server-backup"
          echo "ğŸ”— ECR URI: 319641749746.dkr.ecr.ap-northeast-2.amazonaws.com/ai-server-backup"
          echo "ğŸ·ï¸  ë°°í¬ëœ ì´ë¯¸ì§€ íƒœê·¸:"
          echo "  - llm-server-latest, llm-server-$(echo ${{ github.sha }} | cut -c1-7), llm-server-${{ github.sha }}"
          echo "  - tts-server-latest, tts-server-$(echo ${{ github.sha }} | cut -c1-7), tts-server-${{ github.sha }}"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "ğŸ“ ì»¤ë°‹: ${{ github.sha }}"
          echo "ğŸ‘¤ ì‘ì„±ì: ${{ github.actor }}"
          echo "â° ì™„ë£Œ ì‹œê°„: $(date)"
          echo "ğŸ‰ ëª¨ë“  ì„œë¹„ìŠ¤ ì´ë¯¸ì§€ê°€ ai-server-backup ECR ë¦¬í¬ì§€í† ë¦¬ì— ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "==================================================" 
